<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baby Tyrrell â€” Registry</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        cream: { 50: '#faf9f7', 100: '#f5f3f0', 200: '#ebe7e0', 300: '#ddd7cc' },
        sage: { 100: '#e8ebe7', 200: '#d1d7cf', 300: '#b5bfb3', 400: '#8a9688', 500: '#6b7869', 600: '#556058' },
        warm: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c' }
      },
      fontFamily: {
        serif: ['Crimson Pro', 'Georgia', 'serif'],
        sans: ['Inter', 'system-ui', 'sans-serif']
      }
    }
  }
}
</script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #faf9f7; font-family: 'Inter', sans-serif; color: #44403c; -webkit-font-smoothing: antialiased; }
.shadow-subtle { box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.03); }
.shadow-medium { box-shadow: 0 8px 24px rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.04); }
.glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
.transition-smooth { transition: all 0.3s cubic-bezier(0.4,0,0.2,1); }
.hover-lift:hover { transform: translateY(-2px); }
.serif { font-family: 'Crimson Pro', Georgia, serif; }
input, select, textarea { outline: none; font-family: 'Inter', sans-serif; }
input:focus, select:focus, textarea:focus { ring: none; }

/* Confetti */
@keyframes confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(60px) rotate(360deg); opacity: 0; }
}
.confetti-dot {
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  animation: confetti-fall 0.8s ease-out forwards;
  pointer-events: none;
}

/* Modal */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(68,64,60,0.3);
  backdrop-filter: blur(4px);
  z-index: 50;
  display: flex; align-items: flex-end; justify-content: center;
}
@media (min-width: 768px) {
  .modal-overlay { align-items: center; }
}
.modal-content {
  background: #faf9f7;
  border-radius: 24px 24px 0 0;
  width: 100%; max-width: 600px;
  max-height: 90vh; overflow-y: auto;
  padding: 32px 24px;
  animation: slide-up 0.3s cubic-bezier(0.4,0,0.2,1);
}
@media (min-width: 768px) {
  .modal-content {
    border-radius: 24px;
    max-height: 85vh;
  }
}
@keyframes slide-up {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Progress bar */
.progress-track {
  background: #ebe7e0;
  border-radius: 100px;
  height: 4px;
  overflow: hidden;
}
.progress-fill {
  background: linear-gradient(90deg, #8a9688, #6b7869);
  height: 100%;
  border-radius: 100px;
  transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
}

/* Checkbox */
.check-box {
  width: 24px; height: 24px;
  border: 1.5px solid #b5bfb3;
  border-radius: 8px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
  background: white;
}
.check-box.checked {
  background: #6b7869;
  border-color: #6b7869;
}

/* Tag */
.tag {
  display: inline-flex; align-items: center;
  font-size: 10px; font-weight: 300;
  letter-spacing: 0.08em; text-transform: uppercase;
  padding: 2px 8px; border-radius: 100px;
  background: #ebe7e0; color: #78716c;
}
.tag.essential { background: #e8ebe7; color: #556058; }
.tag.urgent { background: #fef2f2; color: #991b1b; }
.tag.this-week { background: #fefce8; color: #854d0e; }
.tag.soon { background: #f0fdf4; color: #166534; }

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ddd7cc; border-radius: 2px; }

/* Input styles */
.input-field {
  width: 100%;
  background: #faf9f7;
  border: 1px solid #ebe7e0;
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 14px;
  color: #44403c;
  transition: border-color 0.2s;
}
.input-field:focus { border-color: #8a9688; }

/* Fade in */
@keyframes fade-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fade-in 0.4s ease both; }
.fade-in-delay-1 { animation-delay: 0.05s; }
.fade-in-delay-2 { animation-delay: 0.1s; }
.fade-in-delay-3 { animation-delay: 0.15s; }
.fade-in-delay-4 { animation-delay: 0.2s; }

/* Show action buttons on touch devices (no hover) */
@media (hover: none) and (pointer: coarse) {
  .hover-actions { opacity: 1 !important; }
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyBfk_XtlkCtbXaSjFPHxbPTmHaFK_PjGRA",
  authDomain: "baby-registry-0826.firebaseapp.com",
  projectId: "baby-registry-0826",
  storageBucket: "baby-registry-0826.firebasestorage.app",
  messagingSenderId: "755695791502",
  appId: "1:755695791502:web:47d9360de0978238d348df"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();// Lightweight "signal" updates (not a full audit log)
const UPDATE_EVENT_TYPES = {
  PURCHASED_TOGGLED: "PURCHASED_TOGGLED",
  COMMENT_ADDED: "COMMENT_ADDED",
  ASSIGNED_CHANGED: "ASSIGNED_CHANGED"
};

const getUserName = () => {
  try { return localStorage.getItem("registryUser") || ""; } catch { return ""; }
};


const getNameDismissed = () => {
  try { return localStorage.getItem("registryUserDismissed") === "1"; } catch { return false; }
};
const setNameDismissed = (v) => {
  try { localStorage.setItem("registryUserDismissed", v ? "1" : "0"); } catch {}
};
const getLastSeenUpdatesAt = () => {
  try { return parseInt(localStorage.getItem("lastSeenUpdatesAt") || "0", 10) || 0; } catch { return 0; }
};
const setLastSeenUpdatesAt = (ms) => {
  try { localStorage.setItem("lastSeenUpdatesAt", String(ms)); } catch {}
};

const logUpdate = async ({ type, itemId, itemName, category }) => {
  try {
    const by = getUserName() || "Someone";
    await db.collection("updates").add({
      type,
      itemId,
      itemName,
      category,
      by,
      at: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (e) {
    // Non-blocking: registry should still function if updates logging fails
    console.warn("logUpdate failed", e);
  }
};

// Initial data
const INITIAL_ITEMS = [
  { id: 1, item: "Rain Cover", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 2, item: "Pram Sunshade", category: "TRAVEL", mandatory: false, targetMonth: "March", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 3, item: "Bugaboo Fox 5 Pram", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 1299, purchased: false, productPrice: null, actualCost: null, brand: "Bugaboo", link: "", notes: "Main pram, essential before birth", priority: "urgent", assignedTo: "Joe", imageUrl: null, comments: [] },
  { id: 4, item: "Car Seat (Infant)", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 400, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Legally required to leave hospital", priority: "urgent", assignedTo: "Joe", imageUrl: null, comments: [] },
  { id: 5, item: "Pram Organiser Bag", category: "TRAVEL", mandatory: false, targetMonth: "April", estimatedCost: 45, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 6, item: "Stroller Fan", category: "TRAVEL", mandatory: false, targetMonth: "May", estimatedCost: 25, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 7, item: "Travel Changing Mat", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 8, item: "Car Mirror (rear-facing)", category: "TRAVEL", mandatory: false, targetMonth: "April", estimatedCost: 20, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 9, item: "Moses Basket", category: "SLEEPING", mandatory: true, targetMonth: "March", estimatedCost: 120, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Newborn sleeping, first few months", priority: "urgent", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 10, item: "Cot / Crib", category: "SLEEPING", mandatory: true, targetMonth: "April", estimatedCost: 350, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 11, item: "Cot Mattress", category: "SLEEPING", mandatory: true, targetMonth: "April", estimatedCost: 100, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Firm, breathable", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 12, item: "Fitted Cot Sheets x3", category: "SLEEPING", mandatory: true, targetMonth: "April", estimatedCost: 50, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 13, item: "Baby Monitor (video)", category: "SLEEPING", mandatory: true, targetMonth: "April", estimatedCost: 180, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: "Joe", imageUrl: null, comments: [] },
  { id: 14, item: "Swaddle Blankets x4", category: "SLEEPING", mandatory: true, targetMonth: "March", estimatedCost: 60, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Muslin swaddles", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 15, item: "White Noise Machine", category: "SLEEPING", mandatory: false, targetMonth: "March", estimatedCost: 50, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 16, item: "Sleeping Bags (0-6m) x2", category: "SLEEPING", mandatory: true, targetMonth: "March", estimatedCost: 80, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "1 tog and 2.5 tog", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 17, item: "Blackout Blind", category: "SLEEPING", mandatory: false, targetMonth: "April", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 18, item: "Moses Basket Stand", category: "SLEEPING", mandatory: false, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 19, item: "Breast Pump (electric)", category: "FEEDING", mandatory: true, targetMonth: "March", estimatedCost: 200, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Double electric recommended", priority: "urgent", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 20, item: "Bottles x6 (Newborn)", category: "FEEDING", mandatory: true, targetMonth: "March", estimatedCost: 60, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "MAM or Tommee Tippee", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 21, item: "Bottle Steriliser", category: "FEEDING", mandatory: true, targetMonth: "March", estimatedCost: 80, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 22, item: "Bottle Brush", category: "FEEDING", mandatory: true, targetMonth: "March", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 23, item: "Nursing Pillow", category: "FEEDING", mandatory: false, targetMonth: "March", estimatedCost: 50, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Boppy or My Brest Friend", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 24, item: "Breast Pads (washable) x8", category: "FEEDING", mandatory: false, targetMonth: "March", estimatedCost: 20, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 25, item: "Milk Storage Bags x50", category: "FEEDING", mandatory: false, targetMonth: "April", estimatedCost: 15, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 26, item: "Bibs x10", category: "FEEDING", mandatory: true, targetMonth: "March", estimatedCost: 25, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Muslin and waterproof", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 27, item: "High Chair", category: "FEEDING", mandatory: true, targetMonth: "June", estimatedCost: 150, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "When weaning starts ~6m", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 28, item: "Formula (starter pack)", category: "FEEDING", mandatory: false, targetMonth: "March", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "In case breastfeeding doesn't work initially", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 29, item: "Baby Carrier / Wrap", category: "CARRYING", mandatory: true, targetMonth: "March", estimatedCost: 150, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Ergobaby or Solly wrap", priority: "this-week", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 30, item: "Baby Bouncer", category: "CARRYING", mandatory: false, targetMonth: "March", estimatedCost: 120, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Babybjorn Bouncer", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 31, item: "Baby Swing", category: "CARRYING", mandatory: false, targetMonth: "April", estimatedCost: 180, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Electric swing for colicky babies", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 32, item: "Play Mat / Gym", category: "CARRYING", mandatory: true, targetMonth: "April", estimatedCost: 80, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 33, item: "Changing Table / Mat", category: "FURNITURE", mandatory: true, targetMonth: "March", estimatedCost: 200, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: "Joe", imageUrl: null, comments: [] },
  { id: 34, item: "Nursing Chair / Glider", category: "FURNITURE", mandatory: false, targetMonth: "March", estimatedCost: 400, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Very useful for night feeds", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 35, item: "Chest of Drawers (nursery)", category: "FURNITURE", mandatory: true, targetMonth: "April", estimatedCost: 250, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 36, item: "Wardrobe (nursery)", category: "FURNITURE", mandatory: false, targetMonth: "April", estimatedCost: 300, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 37, item: "Nightlight", category: "FURNITURE", mandatory: false, targetMonth: "March", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 38, item: "Baby Bath Tub", category: "BATHING", mandatory: true, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 39, item: "Hooded Baby Towels x3", category: "BATHING", mandatory: true, targetMonth: "March", estimatedCost: 45, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 40, item: "Washcloths x6", category: "BATHING", mandatory: true, targetMonth: "March", estimatedCost: 15, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 41, item: "Baby Bath Support / Seat", category: "BATHING", mandatory: false, targetMonth: "March", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 42, item: "Baby Bath Thermometer", category: "BATHING", mandatory: true, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 43, item: "Baby Shampoo & Wash", category: "BATHING", mandatory: true, targetMonth: "March", estimatedCost: 20, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 44, item: "Digital Thermometer", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 25, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Ear or forehead", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 45, item: "Nail File / Clippers (baby)", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 46, item: "Nasal Aspirator", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 15, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Frida BabyNoseFrida", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 47, item: "Baby First Aid Kit", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 48, item: "Gripe Water / Colic drops", category: "HEALTH", mandatory: false, targetMonth: "March", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 49, item: "Vitamin D Drops", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 8, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "All breastfed babies need this", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 50, item: "Nappy Cream (Metanium)", category: "HEALTH", mandatory: true, targetMonth: "March", estimatedCost: 6, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 51, item: "Bodysuits (newborn) x8", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 50, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Long and short sleeve mix", priority: "urgent", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 52, item: "Sleepsuits (newborn) x6", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 53, item: "Hats (newborn) x3", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 15, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 54, item: "Scratch Mitts x4", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 55, item: "Socks x6 pairs", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 56, item: "Pramsuit / All-in-one (0-3m)", category: "CLOTHING", mandatory: false, targetMonth: "March", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 57, item: "Bodysuits (0-3m) x6", category: "CLOTHING", mandatory: true, targetMonth: "April", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 58, item: "Sleepsuits (0-3m) x4", category: "CLOTHING", mandatory: true, targetMonth: "April", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 59, item: "Nappies (newborn) x200", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Pampers newborn", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 60, item: "Nappies (size 1) x200", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 61, item: "Baby Wipes x20 packs", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "WaterWipes for newborn", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 62, item: "Nappy Bags x200", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 8, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 63, item: "Cotton Wool Balls x200", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 5, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "For newborn skin care", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 64, item: "Nappy Bin + Refills", category: "CONSUMABLES", mandatory: false, targetMonth: "March", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 65, item: "Laundry Detergent (sensitive)", category: "CONSUMABLES", mandatory: true, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Non-bio for newborn clothes", priority: "this-week", assignedTo: null, imageUrl: null, comments: [] },
  { id: 66, item: "Changing Bag", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 80, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "urgent", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 67, item: "Moses Basket Mattress", category: "SLEEPING", mandatory: true, targetMonth: "March", estimatedCost: 35, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Firm, flat", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 68, item: "Room Thermometer", category: "SLEEPING", mandatory: true, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "16-20Â°C ideal for newborn", priority: "urgent", assignedTo: null, imageUrl: null, comments: [] },
  { id: 69, item: "Baby Hairbrush Set", category: "HEALTH", mandatory: false, targetMonth: "April", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 70, item: "Lanolin Nipple Cream", category: "HEALTH", mandatory: false, targetMonth: "March", estimatedCost: 12, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Lansinoh is popular", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 71, item: "Nursing Bras x3", category: "CLOTHING", mandatory: true, targetMonth: "March", estimatedCost: 60, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Get fitted closer to due date", priority: "this-week", assignedTo: "Georgia", imageUrl: null, comments: [] },
  { id: 72, item: "Baby Mittens x2", category: "CLOTHING", mandatory: false, targetMonth: "March", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 73, item: "Nappy Sacks (travel)", category: "CONSUMABLES", mandatory: false, targetMonth: "March", estimatedCost: 5, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 74, item: "Bouncy Chair (separate)", category: "CARRYING", mandatory: false, targetMonth: "May", estimatedCost: 100, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 75, item: "Dummy / Pacifier x3", category: "HEALTH", mandatory: false, targetMonth: "March", estimatedCost: 15, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "MAM or Philips Avent", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 76, item: "Baby Book / Memory Journal", category: "FURNITURE", mandatory: false, targetMonth: "May", estimatedCost: 25, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 77, item: "Soft Toys / Comforters x2", category: "SLEEPING", mandatory: false, targetMonth: "April", estimatedCost: 30, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 78, item: "Baby Lotion / Moisturiser", category: "BATHING", mandatory: false, targetMonth: "March", estimatedCost: 10, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Fragrance-free", priority: "normal", assignedTo: null, imageUrl: null, comments: [] },
  { id: 79, item: "Portable Changing Mat", category: "TRAVEL", mandatory: true, targetMonth: "March", estimatedCost: 20, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "", priority: "soon", assignedTo: null, imageUrl: null, comments: [] },
  { id: 80, item: "Mobile / Cot Toy", category: "SLEEPING", mandatory: false, targetMonth: "April", estimatedCost: 40, purchased: false, productPrice: null, actualCost: null, brand: "", link: "", notes: "Visual stimulation", priority: "normal", assignedTo: null, imageUrl: null, comments: [] }
];

const DEFAULT_SETTINGS = {
  dueDate: "2025-06-15",
  categoryBudgets: {
    TRAVEL: 2000, SLEEPING: 1500, FEEDING: 800, CARRYING: 700,
    FURNITURE: 1200, BATHING: 400, HEALTH: 200, CLOTHING: 1500, CONSUMABLES: 310
  }
};

const CATEGORY_INFO = {
  TRAVEL: { emoji: "ðŸš—", label: "Travel" },
  SLEEPING: { emoji: "ðŸŒ™", label: "Sleeping" },
  FEEDING: { emoji: "ðŸ¼", label: "Feeding" },
  CARRYING: { emoji: "ðŸ‘¶", label: "Carrying" },
  FURNITURE: { emoji: "ðŸª‘", label: "Furniture" },
  BATHING: { emoji: "ðŸ›", label: "Bathing" },
  HEALTH: { emoji: "ðŸ’Š", label: "Health" },
  CLOTHING: { emoji: "ðŸ‘•", label: "Clothing" },
  CONSUMABLES: { emoji: "ðŸ§´", label: "Consumables" }
};

const MONTHS = ["March", "April", "May", "June", "July"];
const PRIORITIES = [
  { value: "urgent", label: "Urgent" },
  { value: "this-week", label: "This Week" },
  { value: "soon", label: "Soon" },
  { value: "normal", label: "Normal" }
];
const PRIORITY_ORDER = { "urgent": 0, "this-week": 1, "soon": 2, "normal": 3 };

// Helper: format currency
const fmt = (n) => n == null ? "â€”" : `Â£${Number(n).toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

// Weeks remaining
const weeksUntil = (dateStr) => {
  const due = new Date(dateStr);
  const now = new Date();
  const diff = due - now;
  return Math.max(0, Math.ceil(diff / (7 * 24 * 60 * 60 * 1000)));
};

const formatDate = (dateStr) => {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
};

// Confetti component
const Confetti = ({ active, onDone }) => {
  const colors = ['#6b7869','#8a9688','#ebe7e0','#ddd7cc','#b5bfb3','#d1d7cf'];
  const dots = Array.from({ length: 8 }, (_, i) => ({
    id: i,
    color: colors[i % colors.length],
    x: -20 + i * 10 + Math.random() * 10,
    delay: i * 0.06
  }));

  useEffect(() => {
    if (active) {
      const t = setTimeout(onDone, 900);
      return () => clearTimeout(t);
    }
  }, [active]);

  if (!active) return null;

  return (
    <div style={{ position: 'absolute', top: 0, left: '50%', pointerEvents: 'none', zIndex: 10 }}>
      {dots.map(d => (
        <div
          key={d.id}
          className="confetti-dot"
          style={{ background: d.color, left: `${d.x}px`, animationDelay: `${d.delay}s` }}
        />
      ))}
    </div>
  );
};

// CheckBox component
const CheckBox = ({ checked, onChange, celebrating }) => (
  <div style={{ position: 'relative' }}>
    <Confetti active={celebrating} onDone={() => {}} />
    <div
      className={`check-box ${checked ? 'checked' : ''}`}
      onClick={onChange}
    >
      {checked && (
        <svg width="12" height="10" viewBox="0 0 12 10" fill="none">
          <path d="M1 5L4.5 8.5L11 1" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
        </svg>
      )}
    </div>
  </div>
);

// Priority tag
const PriorityTag = ({ priority }) => {
  if (!priority || priority === 'normal') return null;
  return <span className={`tag ${priority}`}>{priority.replace('-', ' ')}</span>;
};

// Label component
const Label = ({ children }) => (
  <div style={{ fontSize: 10, fontWeight: 300, letterSpacing: '0.1em', textTransform: 'uppercase', color: '#a8a29e', marginBottom: 4 }}>
    {children}
  </div>
);

// Input component
const Input = ({ label, ...props }) => (
  <div>
    {label && <Label>{label}</Label>}
    <input className="input-field" {...props} />
  </div>
);

// Select component
const Select = ({ label, options, ...props }) => (
  <div>
    {label && <Label>{label}</Label>}
    <select className="input-field" style={{ cursor: 'pointer' }} {...props}>
      {options.map(o => (
        <option key={o.value} value={o.value}>{o.label}</option>
      ))}
    </select>
  </div>
);

// Progress bar
const ProgressBar = ({ pct, style }) => (
  <div className="progress-track" style={style}>
    <div className="progress-fill" style={{ width: `${Math.min(100, pct)}%` }} />
  </div>
);

// Item Form Modal
const ItemFormModal = ({ item, onSave, onClose, categories }) => {
  const [form, setForm] = useState(item || {
    item: '', category: 'TRAVEL', targetMonth: 'March', priority: 'normal',
    assignedTo: null, mandatory: false, pinnedFocus: false, purchased: false,
    estimatedCost: '', productPrice: '', actualCost: '',
    brand: '', link: '', imageUrl: '', notes: ''
  });

  const set = (k, v) => setForm(f => ({ ...f, [k]: v }));

  const handleSave = () => {
    if (!form.item.trim()) return;
    onSave({
      ...form,
      estimatedCost: parseFloat(form.estimatedCost) || 0,
      productPrice: form.productPrice ? parseFloat(form.productPrice) : null,
      actualCost: form.actualCost ? parseFloat(form.actualCost) : null,
      comments: form.comments || []
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h2 className="serif" style={{ fontSize: 24 }}>{item ? 'Edit Item' : 'Add Item'}</h2>
          <button onClick={onClose} style={{ color: '#a8a29e', background: 'none', border: 'none', cursor: 'pointer', fontSize: 20 }}>âœ•</button>
        </div>

        <div style={{ display: 'grid', gap: 16 }}>
          <Input label="Item Name" value={form.item} onChange={e => set('item', e.target.value)} placeholder="e.g. Moses Basket" />

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
            <Select label="Category" value={form.category} onChange={e => set('category', e.target.value)}
              options={Object.entries(CATEGORY_INFO).map(([k, v]) => ({ value: k, label: `${v.emoji} ${v.label}` }))} />
            <Select label="Target Month" value={form.targetMonth} onChange={e => set('targetMonth', e.target.value)}
              options={MONTHS.map(m => ({ value: m, label: m }))} />
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
            <Select label="Priority" value={form.priority} onChange={e => set('priority', e.target.value)}
              options={PRIORITIES} />
            <Select label="Assigned To" value={form.assignedTo || ''} onChange={e => set('assignedTo', e.target.value || null)}
              options={[{ value: '', label: 'Both' }, { value: 'Joe', label: 'Joe' }, { value: 'Georgia', label: 'Georgia' }]} />
          </div>

          <div style={{ display: 'flex', gap: 24, alignItems: 'center' }}>
            <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 14 }}>
              <input type="checkbox" checked={form.mandatory} onChange={e => set('mandatory', e.target.checked)} />
              Essential
            </label>
            <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 14 }}>
              <input type="checkbox" checked={!!form.pinnedFocus} onChange={e => set('pinnedFocus', e.target.checked)} />
              Pin to Focus
            </label>
            <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 14 }}>
              <input type="checkbox" checked={form.purchased} onChange={e => set('purchased', e.target.checked)} />
              Purchased
            </label>
          </div>

          <div style={{ borderTop: '1px solid #ebe7e0', paddingTop: 16 }}>
            <Label>Pricing</Label>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginTop: 8 }}>
              <Input label="Budget" type="number" value={form.estimatedCost} onChange={e => set('estimatedCost', e.target.value)} placeholder="0" />
              <Input label="Product Price" type="number" value={form.productPrice || ''} onChange={e => set('productPrice', e.target.value)} placeholder="0" />
              {form.purchased && <Input label="Actual Cost" type="number" value={form.actualCost || ''} onChange={e => set('actualCost', e.target.value)} placeholder="0" />}
            </div>
          </div>

          <Input label="Brand / Product Name" value={form.brand} onChange={e => set('brand', e.target.value)} placeholder="e.g. Bugaboo" />
          <Input label="Link" value={form.link} onChange={e => set('link', e.target.value)} placeholder="https://..." />
          <Input label="Image URL" value={form.imageUrl || ''} onChange={e => set('imageUrl', e.target.value)} placeholder="https://..." />

          <div>
            <Label>Notes</Label>
            <textarea className="input-field" value={form.notes} onChange={e => set('notes', e.target.value)} placeholder="Any notes..." rows={3} style={{ resize: 'vertical' }} />
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 8 }}>
            <button onClick={onClose} style={{ padding: '12px', border: '1px solid #ebe7e0', borderRadius: 12, background: 'transparent', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 14 }}>
              Cancel
            </button>
            <button onClick={handleSave} style={{ padding: '12px', border: 'none', borderRadius: 12, background: '#6b7869', color: 'white', cursor: 'pointer', fontFamily: 'Inter', fontSize: 14, fontWeight: 500 }}>
              {item ? 'Save Changes' : 'Add Item'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Settings Modal
const SettingsModal = ({ settings, onSave, onClose }) => {
  const [form, setForm] = useState({
    dueDate: settings.dueDate,
    categoryBudgets: { ...settings.categoryBudgets }
  });

  const setBudget = (cat, val) => setForm(f => ({
    ...f, categoryBudgets: { ...f.categoryBudgets, [cat]: parseFloat(val) || 0 }
  }));

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h2 className="serif" style={{ fontSize: 24 }}>Settings</h2>
          <button onClick={onClose} style={{ color: '#a8a29e', background: 'none', border: 'none', cursor: 'pointer', fontSize: 20 }}>âœ•</button>
        </div>

        <div style={{ display: 'grid', gap: 20 }}>
          <Input label="Due Date" type="date" value={form.dueDate} onChange={e => setForm(f => ({ ...f, dueDate: e.target.value }))} />

          <div>
            <Label>Category Budgets</Label>
            <div style={{ display: 'grid', gap: 12, marginTop: 8 }}>
              {Object.entries(CATEGORY_INFO).map(([cat, info]) => (
                <div key={cat} style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <span style={{ width: 24, textAlign: 'center' }}>{info.emoji}</span>
                  <span style={{ fontSize: 13, color: '#57534e', width: 90 }}>{info.label}</span>
                  <input type="number" className="input-field" style={{ flex: 1 }}
                    value={form.categoryBudgets[cat] || ''}
                    onChange={e => setBudget(cat, e.target.value)} />
                </div>
              ))}
            </div>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
            <button onClick={onClose} style={{ padding: '12px', border: '1px solid #ebe7e0', borderRadius: 12, background: 'transparent', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 14 }}>
              Cancel
            </button>
            <button onClick={() => { onSave(form); onClose(); }} style={{ padding: '12px', border: 'none', borderRadius: 12, background: '#6b7869', color: 'white', cursor: 'pointer', fontFamily: 'Inter', fontSize: 14, fontWeight: 500 }}>
              Save Settings
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};



// Name Modal (stores locally per device)
const NameModal = ({ initialName, onSave, onClose }) => {
  const [name, setName] = useState(initialName || '');

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h2 className="serif" style={{ fontSize: 24 }}>Who is using this?</h2>
          <button onClick={onClose} style={{ color: '#a8a29e', background: 'none', border: 'none', cursor: 'pointer', fontSize: 20 }}>âœ•</button>
        </div>

        <div style={{ display: 'grid', gap: 16 }}>
          <div style={{ fontSize: 13, color: '#78716c', lineHeight: 1.4 }}>
            This only sets the name on this device so updates show as Joe or Georgia.
          </div>

          <select className="input-field" value={name} onChange={e => setName(e.target.value)} style={{ cursor: 'pointer' }}>
            <option value="">Choose</option>
            <option value="Joe">Joe</option>
            <option value="Georgia">Georgia</option>
          </select>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 8 }}>
            <button onClick={onClose} style={{ padding: '12px', border: '1px solid #ebe7e0', borderRadius: 12, background: 'transparent', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 14 }}>
              Not now
            </button>
            <button onClick={() => { onSave(name); onClose(); }} disabled={!name}
              style={{ padding: '12px', border: 'none', borderRadius: 12, background: name ? '#6b7869' : '#ddd7cc', color: 'white', cursor: name ? 'pointer' : 'not-allowed', fontFamily: 'Inter', fontSize: 14, fontWeight: 500 }}>
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};


// Month helpers
const MONTH_NUM = { January:0, February:1, March:2, April:3, May:4, June:5, July:6, August:7, September:8, October:9, November:10, December:11 };

const getAllowedMonths = (settings) => {
  // Uses the dueDate year as the timeline year (so March-Aug are in the due year)
  try {
    const due = settings && settings.dueDate ? new Date(settings.dueDate) : new Date();
    const year = due.getFullYear();
    const now = new Date();

    return MONTHS.filter(m => {
      const mi = MONTH_NUM[m];
      if (mi === undefined) return true;
      // end of month
      const end = new Date(year, mi + 1, 0, 23, 59, 59, 999);
      return now.getTime() <= end.getTime();
    });
  } catch (e) {
    return MONTHS;
  }
};

const MonthTagSelect = ({ value, settings, onChange, disabled }) => {
  const allowed = getAllowedMonths(settings);
  // Ensure the current value is present so the select can render correctly
  const options = allowed.includes(value) ? allowed : [value, ...allowed];

  return (
    <select
      className="tag"
      disabled={disabled}
      value={value}
      onChange={(e) => onChange && onChange(e.target.value)}
      title="Change month"
      style={{
        border: 'none',
        cursor: disabled ? 'default' : 'pointer',
        appearance: 'none',
        WebkitAppearance: 'none',
        MozAppearance: 'none',
        paddingRight: 18,
        backgroundImage: disabled ? 'none' : 'linear-gradient(45deg, transparent 50%, #78716c 50%), linear-gradient(135deg, #78716c 50%, transparent 50%)',
        backgroundPosition: disabled ? 'none' : 'calc(100% - 10px) 55%, calc(100% - 6px) 55%',
        backgroundSize: disabled ? 'none' : '4px 4px, 4px 4px',
        backgroundRepeat: 'no-repeat',
      }}
    >
      {options.map(m => (
        <option key={m} value={m} disabled={!allowed.includes(m) && m !== value}>
          {m}
        </option>
      ))}
    </select>
  );
};

// Item Card (in category view)
const ItemCard = ({ item, settings, onToggle, onEdit, onDelete, onAddComment, onChangeMonth, onTogglePin, showCategoryTag, variant = 'card', celebrating }) => {
  const [showComments, setShowComments] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [commentAuthor, setCommentAuthor] = useState('Georgia');
  const [hover, setHover] = useState(false);

  const latestComment = item.comments && item.comments.length > 0
    ? item.comments[item.comments.length - 1] : null;

  const handleAddComment = () => {
    if (!commentText.trim()) return;
    onAddComment(item.id, { text: commentText, author: commentAuthor, timestamp: new Date().toISOString() });
    setCommentText('');
  };

  const timeAgo = (iso) => {
    const diff = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
  };

  return (
    <div
      className="transition-smooth"
      onMouseEnter={() => setHover(true)}
      onMouseLeave={() => setHover(false)}
      style={{
        background: variant === 'line' ? 'transparent' : 'white',
        border: variant === 'line' ? 'none' : '1px solid #ebe7e0',
        borderRadius: variant === 'line' ? 0 : 16,
        padding: variant === 'line' ? '14px 0' : '16px',
        opacity: item.purchased ? 0.55 : 1,
        transition: 'all 0.3s',
        position: 'relative'
      }}
    >
      <div style={{ display: 'flex', gap: 12, alignItems: 'flex-start' }}>
        <div style={{ position: 'relative', paddingTop: 2 }}>
          <CheckBox checked={item.purchased} onChange={() => onToggle(item.id)} celebrating={celebrating} />
        </div>

        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: 'flex', gap: 8, alignItems: 'flex-start', flexWrap: 'wrap' }}>
            {item.imageUrl && (
              <img src={item.imageUrl} alt={item.item}
                style={{ width: 56, height: 56, objectFit: 'cover', borderRadius: 8, float: 'right', marginLeft: 8 }}
                onError={e => e.target.style.display = 'none'} />
            )}
            <div style={{ flex: 1 }}>
              <div className="serif" style={{
                fontSize: 20,
                textDecoration: item.purchased ? 'line-through' : 'none',
                color: '#44403c',
                lineHeight: 1.2,
                marginBottom: 6
              }}>
                {item.item}
              </div>
              <div style={{ display: 'flex', gap: 4, flexWrap: 'wrap', marginBottom: 6 }}>
                <MonthTagSelect value={item.targetMonth} settings={settings} onChange={(m) => onChangeMonth && onChangeMonth(item.id, m)} />
                {item.mandatory && <span className="tag essential">Essential</span>}
                {showCategoryTag && (
                  <span className="tag">{((CATEGORY_INFO[item.category] && CATEGORY_INFO[item.category].emoji) || '')} {((CATEGORY_INFO[item.category] && CATEGORY_INFO[item.category].label) || item.category)}</span>
                )}
                <PriorityTag priority={item.priority} />
                {item.assignedTo && <span className="tag">{item.assignedTo}</span>}
              </div>

              {(item.estimatedCost || item.productPrice || item.actualCost) && (
                <div style={{ display: 'flex', gap: 12, marginBottom: 6 }}>
                  {item.estimatedCost > 0 && <span style={{ fontSize: 12, color: '#a8a29e' }}>Budget: {fmt(item.estimatedCost)}</span>}
                  {item.productPrice && <span style={{ fontSize: 12, color: '#6b7869' }}>Price: {fmt(item.productPrice)}</span>}
                  {item.actualCost && <span style={{ fontSize: 12, color: '#556058', fontWeight: 500 }}>Paid: {fmt(item.actualCost)}</span>}
                </div>
              )}

              {item.notes && (
                <div style={{ fontSize: 13, color: '#78716c', fontStyle: 'italic', marginBottom: 6 }}>{item.notes}</div>
              )}

              {latestComment && !showComments && (
                <div style={{ fontSize: 12, color: '#a8a29e', display: 'flex', alignItems: 'center', gap: 4 }}>
                  <div style={{ width: 6, height: 6, borderRadius: '50%', background: '#8a9688' }} />
                  <span style={{ fontWeight: 500, color: '#78716c' }}>{typeof latestComment === 'string' ? '' : (latestComment.author || '')}:</span>
                  <span style={{ overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{typeof latestComment === 'string' ? latestComment : (latestComment.text || '')}</span>
                </div>
              )}

              {item.link && (
                <a href={item.link} target="_blank" rel="noopener noreferrer"
                  style={{ fontSize: 12, color: '#6b7869', textDecoration: 'none', display: 'inline-flex', alignItems: 'center', gap: 4 }}>
                  â†— View Product
                </a>
              )}
            </div>
          </div>
        </div>

        {/* Action buttons */}
        <div style={{ display: 'flex', gap: 4, opacity: hover ? 1 : 0, transition: 'opacity 0.2s', flexShrink: 0 }}
          className="md:flex hover-actions">
          <button onClick={() => onTogglePin && onTogglePin(item.id)} title={item.pinnedFocus ? "Unpin from Focus" : "Pin to Focus"}
            style={{ padding: '6px', border: 'none', background: item.pinnedFocus ? '#e8ebe7' : '#f5f3f0', borderRadius: 8, cursor: 'pointer', color: '#78716c', fontSize: 14 }}>ðŸ“Œ</button>
          <button onClick={() => setShowComments(!showComments)}
            style={{ padding: '6px', border: 'none', background: '#f5f3f0', borderRadius: 8, cursor: 'pointer', color: '#78716c', fontSize: 14, position: 'relative' }}>
            ðŸ’¬{item.comments && item.comments.length > 0 && (
              <span style={{ position: 'absolute', top: 2, right: 2, width: 6, height: 6, borderRadius: '50%', background: '#6b7869' }} />
            )}
          </button>
          <button onClick={() => onEdit(item)}
            style={{ padding: '6px', border: 'none', background: '#f5f3f0', borderRadius: 8, cursor: 'pointer', color: '#78716c', fontSize: 14 }}>âœï¸</button>
          <button onClick={() => onDelete(item.id)}
            style={{ padding: '6px', border: 'none', background: '#f5f3f0', borderRadius: 8, cursor: 'pointer', color: '#78716c', fontSize: 14 }}>ðŸ—‘</button>
        </div>
      </div>

      {/* Comments panel */}
      {showComments && (
        <div style={{ marginTop: 16, borderTop: '1px solid #ebe7e0', paddingTop: 12 }}>
          {item.comments && item.comments.map((c, i) => (
            <div key={i} style={{ marginBottom: 8 }}>
              <div style={{ display: 'flex', gap: 6, alignItems: 'baseline' }}>
                <span style={{ fontSize: 12, fontWeight: 500, color: '#57534e' }}>{c.author}</span>
                <span style={{ fontSize: 11, color: '#a8a29e' }}>{timeAgo(c.timestamp)}</span>
              </div>
              <div style={{ fontSize: 13, color: '#57534e', marginTop: 2 }}>{c.text}</div>
            </div>
          ))}
          <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
            <select className="input-field" value={commentAuthor} onChange={e => setCommentAuthor(e.target.value)} style={{ width: 100, flexShrink: 0, padding: '8px 10px', fontSize: 13 }}>
              <option>Georgia</option>
              <option>Joe</option>
            </select>
            <input className="input-field" value={commentText} onChange={e => setCommentText(e.target.value)}
              placeholder="Add a comment..." style={{ flex: 1, padding: '8px 12px', fontSize: 13 }}
              onKeyDown={e => e.key === 'Enter' && handleAddComment()} />
            <button onClick={handleAddComment}
              style={{ padding: '8px 16px', border: 'none', borderRadius: 10, background: '#6b7869', color: 'white', cursor: 'pointer', fontFamily: 'Inter', fontSize: 13, whiteSpace: 'nowrap' }}>
              Add
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// Category View
const CategoryView = ({ category, items, settings, onBack, onToggle, onEdit, onDelete, onAddComment, onChangeMonth, onTogglePin, onAdd, celebratingId }) => {
  const [filterOpen, setFilterOpen] = useState(false);
  const [filter, setFilter] = useState({ search: '', mandatory: 'all', priority: 'all', purchased: 'all' });
  const [searchVal, setSearchVal] = useState('');
  const searchTimer = useRef(null);

  const handleSearch = (v) => {
    setSearchVal(v);
    clearTimeout(searchTimer.current);
    searchTimer.current = setTimeout(() => setFilter(f => ({ ...f, search: v })), 300);
  };

  const info = CATEGORY_INFO[category];
  const catItems = items.filter(i => i.category === category);
  const purchased = catItems.filter(i => i.purchased).length;

  const filtered = catItems.filter(i => {
    if (filter.search && !i.item.toLowerCase().includes(filter.search.toLowerCase())) return false;
    if (filter.mandatory === 'essential' && !i.mandatory) return false;
    if (filter.mandatory === 'optional' && i.mandatory) return false;
    if (filter.priority !== 'all' && i.priority !== filter.priority) return false;
    if (filter.purchased === 'yes' && !i.purchased) return false;
    if (filter.purchased === 'no' && i.purchased) return false;
    return true;
  }).sort((a, b) => PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority]);

  return (
    <div style={{ minHeight: '100vh', background: '#faf9f7', paddingBottom: 80 }}>
      {/* Header */}
      <div style={{ padding: '24px 20px 0', maxWidth: 680, margin: '0 auto' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 20 }}>
          <button onClick={onBack} style={{ border: 'none', background: '#f5f3f0', borderRadius: 10, padding: '8px 14px', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 13, display: 'flex', alignItems: 'center', gap: 6 }}>
            â† Back
          </button>
          <div style={{ flex: 1 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 28 }}>{info.emoji}</span>
              <h2 className="serif" style={{ fontSize: 28 }}>{info.label}</h2>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginTop: 4 }}>
              <ProgressBar pct={(purchased / catItems.length) * 100} style={{ flex: 1 }} />
              <span style={{ fontSize: 12, color: '#a8a29e', whiteSpace: 'nowrap' }}>{purchased} / {catItems.length}</span>
            </div>
          </div>
          <button onClick={() => setFilterOpen(!filterOpen)}
            style={{ border: '1px solid #ebe7e0', background: filterOpen ? '#e8ebe7' : 'white', borderRadius: 10, padding: '8px 14px', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 13 }}>
            Filter
          </button>
        </div>

        {filterOpen && (
          <div style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 16, padding: 16, marginBottom: 16, display: 'grid', gap: 12 }}>
            <input className="input-field" value={searchVal} onChange={e => handleSearch(e.target.value)} placeholder="Search items..." />
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 8 }}>
              <select className="input-field" value={filter.mandatory} onChange={e => setFilter(f => ({ ...f, mandatory: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="all">All Items</option>
                <option value="essential">Essential</option>
                <option value="optional">Optional</option>
              </select>
              <select className="input-field" value={filter.priority} onChange={e => setFilter(f => ({ ...f, priority: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="all">All Priority</option>
                {PRIORITIES.map(p => <option key={p.value} value={p.value}>{p.label}</option>)}
              </select>
              <select className="input-field" value={filter.purchased} onChange={e => setFilter(f => ({ ...f, purchased: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="all">All Status</option>
                <option value="no">To Buy</option>
                <option value="yes">Purchased</option>
              </select>
            </div>
          </div>
        )}
      </div>

      {/* Items */}
      <div style={{ padding: '0 20px', maxWidth: 680, margin: '0 auto', display: 'grid', gap: 10 }}>
        {filtered.map(item => (
          <ItemCard
            key={item.id}
            item={item}
            settings={settings}
            onToggle={onToggle}
            onEdit={onEdit}
            onDelete={onDelete}
            onAddComment={onAddComment}
            onChangeMonth={onChangeMonth}
            onTogglePin={onTogglePin}
            celebrating={celebratingId === item.id}
          />
        ))}

        {filtered.length === 0 && (
          <div style={{ textAlign: 'center', padding: '60px 20px', color: '#a8a29e', fontSize: 14 }}>
            No items found
          </div>
        )}
      </div>

      {/* Add button */}
      <div style={{ position: 'fixed', bottom: 24, right: 24, zIndex: 20 }}>
        <button onClick={() => onAdd(category)}
          style={{ width: 56, height: 56, borderRadius: '50%', background: '#6b7869', border: 'none', color: 'white', fontSize: 24, cursor: 'pointer', boxShadow: '0 8px 24px rgba(107,120,105,0.35)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontFamily: 'Inter' }}
          className="hover-lift transition-smooth">
          +
        </button>
      </div>
    </div>
  );
};




// Timeline View (all items grouped by month)
const TimelineView = ({ items, settings, onBack, onToggle, onEdit, onDelete, onAddComment, onChangeMonth, onTogglePin, celebratingId }) => {
  const [filterOpen, setFilterOpen] = useState(false);
  const [filter, setFilter] = useState({ search: '', category: 'all', mandatory: 'all', purchased: 'no' });
  const [searchVal, setSearchVal] = useState('');
  const searchTimer = useRef(null);

  const handleSearch = (v) => {
    setSearchVal(v);
    clearTimeout(searchTimer.current);
    searchTimer.current = setTimeout(() => setFilter(f => ({ ...f, search: v })), 250);
  };

  const monthIndex = (m) => {
    const idx = MONTHS.indexOf(m);
    return idx === -1 ? 999 : idx;
  };

  const filtered = useMemo(() => {
    return items
      .filter(i => {
        if (filter.purchased === 'no' && i.purchased) return false;
        if (filter.purchased === 'yes' && !i.purchased) return false;
        if (filter.search && !(i.item || '').toLowerCase().includes(filter.search.toLowerCase())) return false;
        if (filter.category !== 'all' && i.category !== filter.category) return false;
        if (filter.mandatory === 'essential' && !i.mandatory) return false;
        if (filter.mandatory === 'optional' && i.mandatory) return false;
        return true;
      })
      .sort((a, b) => {
        const ma = monthIndex(a.targetMonth);
        const mb = monthIndex(b.targetMonth);
        if (ma !== mb) return ma - mb;
        const pa = PRIORITY_ORDER[a.priority] ?? 3;
        const pb = PRIORITY_ORDER[b.priority] ?? 3;
        if (pa !== pb) return pa - pb;
        return (a.item || '').localeCompare(b.item || '');
      });
  }, [items, filter]);

  const grouped = useMemo(() => {
    const g = {};
    filtered.forEach(i => { (g[i.targetMonth] ||= []).push(i); });
    // Ensure consistent month order
    const ordered = {};
    MONTHS.forEach(m => { if (g[m] && g[m].length) ordered[m] = g[m]; });
    // Any unknown months at end
    Object.keys(g).forEach(m => { if (!ordered[m]) ordered[m] = g[m]; });
    return ordered;
  }, [filtered]);

  const total = filtered.length;
  const done = filtered.filter(i => i.purchased).length;

  return (
    <div style={{ minHeight: '100vh', background: '#faf9f7', paddingBottom: 80 }}>
      <div style={{ padding: '24px 20px 0', maxWidth: 720, margin: '0 auto' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 16 }}>
          <button onClick={onBack} style={{ border: 'none', background: '#f5f3f0', borderRadius: 10, padding: '8px 14px', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 13, display: 'flex', alignItems: 'center', gap: 6 }}>
            â† Back
          </button>
          <div style={{ flex: 1 }}>
            <h2 className="serif" style={{ fontSize: 28 }}>Timeline</h2>
            <div style={{ fontSize: 12, color: '#a8a29e', marginTop: 2 }}>
              {done} of {total} purchased
            </div>
          </div>
          <button onClick={() => setFilterOpen(!filterOpen)}
            style={{ border: '1px solid #ebe7e0', background: filterOpen ? '#e8ebe7' : 'white', borderRadius: 10, padding: '8px 14px', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 13 }}>
            Filter
          </button>
        </div>

        {filterOpen && (
          <div style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 16, padding: 16, marginBottom: 16, display: 'grid', gap: 12 }}>
            <input className="input-field" value={searchVal} onChange={e => handleSearch(e.target.value)} placeholder="Search items..." />
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 8 }}>
              <select className="input-field" value={filter.category} onChange={e => setFilter(f => ({ ...f, category: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="all">All Categories</option>
                {Object.entries(CATEGORY_INFO).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
              </select>
              <select className="input-field" value={filter.mandatory} onChange={e => setFilter(f => ({ ...f, mandatory: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="all">All Items</option>
                <option value="essential">Essential</option>
                <option value="optional">Optional</option>
              </select>
              <select className="input-field" value={filter.purchased} onChange={e => setFilter(f => ({ ...f, purchased: e.target.value }))} style={{ padding: '8px 10px', fontSize: 13 }}>
                <option value="no">To Buy</option>
                <option value="yes">Purchased</option>
                <option value="all">All Status</option>
              </select>
            </div>
          </div>
        )}
      </div>

      <div style={{ padding: '0 20px', maxWidth: 720, margin: '0 auto', display: 'grid', gap: 16 }}>
        {Object.keys(grouped).length === 0 && (
          <div style={{ textAlign: 'center', padding: '60px 20px', color: '#a8a29e', fontSize: 14 }}>
            No items found
          </div>
        )}

        {Object.entries(grouped).map(([month, monthItems]) => (
          <div key={month} style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 18, overflow: 'hidden' }}>
            <div style={{ padding: '14px 16px', borderBottom: '1px solid #f5f3f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div className="serif" style={{ fontSize: 18, color: '#44403c' }}>{month}</div>
              <div style={{ fontSize: 12, color: '#a8a29e' }}>{monthItems.filter(i => i.purchased).length} / {monthItems.length}</div>
            </div>
            <div style={{ display: 'grid' }}>
              {monthItems.map((item, idx) => (
                <div key={item.id} style={{ borderBottom: idx < monthItems.length - 1 ? '1px solid #f5f3f0' : 'none', padding: '0 16px' }}>
                  <ItemCard
                    item={item}
                    settings={settings}
                    variant="line"
                    showCategoryTag
                    onToggle={onToggle}
                    onEdit={onEdit}
                    onDelete={onDelete}
                    onAddComment={onAddComment}
                    onChangeMonth={onChangeMonth}
                    onTogglePin={onTogglePin}
                    celebrating={celebratingId === item.id}
                  />
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// Purchased Items Modal
const PurchasedModal = ({ items, onClose, onToggle }) => {
  const purchased = useMemo(() => items.filter(i => i.purchased).sort((a,b) => (a.category||'').localeCompare(b.category||'') || (a.item||'').localeCompare(b.item||'')), [items]);
  const grouped = useMemo(() => {
    const g = {};
    purchased.forEach(i => { (g[i.category] ||= []).push(i); });
    return g;
  }, [purchased]);

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <h2 className="serif" style={{ fontSize: 24 }}>Purchased</h2>
          <button onClick={onClose} style={{ color: '#a8a29e', background: 'none', border: 'none', cursor: 'pointer', fontSize: 20 }}>âœ•</button>
        </div>

        {purchased.length === 0 ? (
          <div style={{ fontSize: 14, color: '#78716c' }}>Nothing marked as purchased yet.</div>
        ) : (
          <div style={{ display: 'grid', gap: 16 }}>
            {Object.keys(grouped).map(cat => (
              <div key={cat} style={{ border: '1px solid #ebe7e0', borderRadius: 16, background: 'white', padding: 14 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>
                  <span style={{ fontSize: 18 }}>{(CATEGORY_INFO[cat] && CATEGORY_INFO[cat].emoji) || 'âœ”ï¸'}</span>
                  <div style={{ fontSize: 14, color: '#57534e', fontWeight: 500 }}>{(CATEGORY_INFO[cat] && CATEGORY_INFO[cat].label) || cat}</div>
                  <div style={{ fontSize: 12, color: '#a8a29e' }}>({grouped[cat].length})</div>
                </div>
                <div style={{ display: 'grid', gap: 8 }}>
                  {grouped[cat].map(i => (
                    <div key={i.id} style={{ display: 'flex', justifyContent: 'space-between', gap: 12, alignItems: 'center' }}>
                      <div style={{ fontSize: 13, color: '#57534e' }}>{i.item}</div>
                      <div style={{ display: 'flex', gap: 10, alignItems: 'center', flexShrink: 0 }}>
                        {i.actualCost ? <div style={{ fontSize: 12, color: '#a8a29e' }}>{fmt(i.actualCost)}</div> : null}
                        <button onClick={() => onToggle && onToggle(i.id)}
                          style={{ padding: '6px 10px', border: '1px solid #ebe7e0', borderRadius: 10, background: '#faf9f7', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 12 }}>
                          Unmark
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// Home Dashboard
const HomeDashboard = ({ items, settings, updatesRaw, userName, onSetUserName, onMarkUpdatesSeen, hasNewUpdates, hideActivityPanel, onHideActivityPanel, onOpenPurchased, onCategoryClick, onToggle, onEdit, onDelete, onAddComment, onChangeMonth, onTogglePin, celebratingId, onOpenSettings, onOpenTimeline, onAdd }) => {
  const weeks = weeksUntil(settings.dueDate);
  const total = items.length;
  const done = items.filter(i => i.purchased).length;
  const pct = Math.round((done / total) * 100);

  // Budget stats
  const estimated = items.reduce((s, i) => s + (i.estimatedCost || 0), 0);
  const identified = items.reduce((s, i) => s + (i.productPrice || 0), 0);
  const spent = items.reduce((s, i) => s + (i.actualCost || 0), 0);
  const saving = estimated - spent;


// Recent activity (signal layer): last 7 days, max 5 unique items
const recentActivity = useMemo(() => {
  const now = Date.now();
  const cutoff = now - 7 * 24 * 60 * 60 * 1000;
  const allowed = new Set(["PURCHASED_TOGGLED", "COMMENT_ADDED", "ASSIGNED_CHANGED"]);
  const byItem = new Set();
  const out = [];

  for (const u of (updatesRaw || [])) {
    if (!u) continue;
    if (!allowed.has(u.type)) continue;
    if (!u.at) continue;
    const ms =  (u.at && typeof u.at.toMillis === 'function') ? u.at.toMillis() : (u.at && u.at.seconds ? u.at.seconds * 1000 : null);
    if (!ms || ms < cutoff) continue;
    if (byItem.has(u.itemId)) continue;
    byItem.add(u.itemId);
    out.push({ ...u, ms });
    if (out.length >= 5) break;
  }
  return out;
}, [updatesRaw]);

useEffect(() => {
  // If something new arrives after being marked seen, show the panel again
  if (hasNewUpdates) onHideActivityPanel(false);
}, [hasNewUpdates]);


const formatAgo = (ms) => {
  const mins = Math.floor((Date.now() - ms) / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
};

const describeUpdate = (u) => {
  if (u.type === "PURCHASED_TOGGLED") return "marked purchased";
  if (u.type === "COMMENT_ADDED") return "added a comment";
  if (u.type === "ASSIGNED_CHANGED") return "updated assignment";
  return "updated";
};
  // Focus items: next up based on timeline (earliest month first), then high ticket value, then essential/priority
  const focusItems = useMemo(() => {
    const open = items.filter(i => !i.purchased);
    if (open.length === 0) return [];

    const monthIndex = (m) => {
      const idx = MONTHS.indexOf(m);
      return idx === -1 ? 999 : idx;
    };

    // Manual pin: always surface pinned items first (up to 4)
    const pinned = open
      .filter(i => !!i.pinnedFocus)
      .sort((a, b) => {
        const ma = monthIndex(a.targetMonth);
        const mb = monthIndex(b.targetMonth);
        if (ma !== mb) return ma - mb;
        const pa = (PRIORITY_ORDER[a.priority] !== undefined ? PRIORITY_ORDER[a.priority] : 3);
        const pb = (PRIORITY_ORDER[b.priority] !== undefined ? PRIORITY_ORDER[b.priority] : 3);
        if (pa !== pb) return pa - pb;
        const ca = -(Math.max(a.productPrice || 0, a.estimatedCost || 0));
        const cb = -(Math.max(b.productPrice || 0, b.estimatedCost || 0));
        return ca - cb;
      });

    const remainingSlots = Math.max(0, 4 - pinned.length);
    if (remainingSlots === 0) return pinned.slice(0, 4);

    const unpinned = open.filter(i => !i.pinnedFocus);
    if (unpinned.length === 0) return pinned.slice(0, 4);

    const earliest = Math.min(...unpinned.map(i => monthIndex(i.targetMonth)));

    // Focus on items due in the earliest month; if fewer than needed, pull from the next month too
    const candidates = unpinned.filter(i => {
      const idx = monthIndex(i.targetMonth);
      return idx === earliest || (idx === earliest + 1);
    });

    const score = (i) => {
      const idx = monthIndex(i.targetMonth);
      const cost = -(Math.max(i.productPrice || 0, i.estimatedCost || 0)); // higher ticket first
      const essentialBoost = i.mandatory ? -1 : 0;
      const pr = (PRIORITY_ORDER[i.priority] !== undefined ? PRIORITY_ORDER[i.priority] : 3);
      return [idx, cost, essentialBoost + pr];
    };

    const auto = candidates
      .sort((a, b) => {
        const sa = score(a);
        const sb = score(b);
        if (sa[0] !== sb[0]) return sa[0] - sb[0];
        if (sa[1] !== sb[1]) return sa[1] - sb[1];
        return sa[2] - sb[2];
      })
      .slice(0, remainingSlots);

    return [...pinned.slice(0, 4), ...auto].slice(0, 4);
  }, [items]);


  // Category stats
  const catStats = useMemo(() => {
    return Object.entries(CATEGORY_INFO).map(([cat, info]) => {
      const catItems = items.filter(i => i.category === cat);
      const catDone = catItems.filter(i => i.purchased).length;
      return { cat, info, total: catItems.length, done: catDone, pct: catItems.length ? Math.round((catDone / catItems.length) * 100) : 0 };
    });
  }, [items]);

  const StatBox = ({ label, value, sub }) => (
    <div style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 16, padding: '16px' }}>
      <Label>{label}</Label>
      <div className="serif" style={{ fontSize: 28, color: '#44403c', marginTop: 4 }}>{value}</div>
      {sub && <div style={{ fontSize: 11, color: '#a8a29e', marginTop: 2 }}>{sub}</div>}
    </div>
  );

  return (
    <div style={{ minHeight: '100vh', background: '#faf9f7', paddingBottom: 60 }}>
      {/* Header */}
      <div style={{ padding: '40px 24px 0', maxWidth: 720, margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 8 }}>
          <div>
            <h1 className="serif fade-in" style={{ fontSize: 'clamp(40px, 8vw, 60px)', lineHeight: 1, letterSpacing: '-0.02em', color: '#44403c' }}>
              Baby Tyrrell
            </h1>
            <div className="serif fade-in fade-in-delay-1" style={{ fontSize: 14, color: '#a8a29e', fontStyle: 'italic', marginTop: 4 }}>
              Thoughtfully preparing for your arrival
            </div>
          </div>
          <button onClick={onOpenSettings}
            style={{ border: '1px solid #ebe7e0', background: 'white', borderRadius: 12, padding: '8px 12px', cursor: 'pointer', color: '#78716c', marginTop: 8 }}>
            âš™ï¸
          </button>
        </div>

        {/* Due date & progress */}
        <div className="fade-in fade-in-delay-2" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 28, marginBottom: 28 }}>
          <div onClick={onOpenTimeline} style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 20, padding: '20px', cursor: 'pointer' }}>
            <Label>Due Date</Label>
            <div className="serif" style={{ fontSize: 22, marginTop: 4 }}>{formatDate(settings.dueDate)}</div>
            <div style={{ display: 'flex', alignItems: 'baseline', gap: 6, marginTop: 8 }}>
              <span className="serif" style={{ fontSize: 48, color: '#8a9688', lineHeight: 1 }}>{weeks}</span>
              <span style={{ fontSize: 13, color: '#a8a29e' }}>weeks to go</span>
            </div>
          </div>
          <div onClick={onOpenPurchased} style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 20, padding: '20px', cursor: 'pointer' }}>
            <Label>Overall Progress</Label>
            <div className="serif" style={{ fontSize: 22, marginTop: 4 }}>{done} of {total}</div>
            <ProgressBar pct={pct} style={{ marginTop: 12, marginBottom: 6 }} />
            <div style={{ fontSize: 12, color: '#a8a29e' }}>{pct}% complete</div>
          </div>
        </div>

{/* Recent activity (signal layer) */}
{recentActivity.length >= 2 && hasNewUpdates && !hideActivityPanel && (
  <div className="fade-in fade-in-delay-2" style={{ marginBottom: 28 }}>
    <div style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 20, padding: 20 }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          <span className="serif" style={{ fontSize: 22, color: '#44403c' }}>Recent activity</span>
          {hasNewUpdates && (
            <span style={{ width: 8, height: 8, borderRadius: '50%', background: '#6b7869', display: 'inline-block' }} />
          )}
        </div>
        <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
          <button onClick={onMarkUpdatesSeen}
            style={{ border: '1px solid #ebe7e0', background: 'transparent', borderRadius: 10, padding: '6px 10px', cursor: 'pointer', color: '#78716c', fontFamily: 'Inter', fontSize: 12 }}>
            Mark seen
          </button>
          <button onClick={onSetUserName}
            style={{ border: '1px solid #ebe7e0', background: '#faf9f7', borderRadius: 10, padding: '6px 10px', cursor: 'pointer', color: '#57534e', fontFamily: 'Inter', fontSize: 12 }}>
            You: {userName || 'set name'}
          </button>
        </div>
      </div>

      <div style={{ display: 'grid', gap: 10 }}>
        {recentActivity.map(u => (
          <div key={u.id} style={{ display: 'flex', justifyContent: 'space-between', gap: 12 }}>
            <div style={{ minWidth: 0 }}>
              <div style={{ fontSize: 13, color: '#57534e', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                <span style={{ fontWeight: 500 }}>{u.itemName}</span>
                <span style={{ color: '#a8a29e' }}> {describeUpdate(u)} </span>
                <span style={{ color: '#78716c' }}>by {u.by || 'Someone'}</span>
              </div>
              <div style={{ fontSize: 11, color: '#a8a29e', marginTop: 2 }}>
                {u.category ? `${(CATEGORY_INFO[u.category] && CATEGORY_INFO[u.category].emoji) || ''} ${(CATEGORY_INFO[u.category] && CATEGORY_INFO[u.category].label) || u.category}` : '' }
              </div>
            </div>
            <div style={{ fontSize: 12, color: '#a8a29e', whiteSpace: 'nowrap' }}>{formatAgo(u.ms)}</div>
          </div>
        ))}
      </div>

      <div style={{ fontSize: 11, color: '#a8a29e', marginTop: 12 }}>
        Shows the last 7 days, up to 5 items, only big updates.
      </div>
    </div>
  </div>
)}

        {/* Focus section */}
        <div className="fade-in fade-in-delay-2" style={{ marginBottom: 28 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: 14 }}>
            <div>
              <span className="serif" style={{ fontSize: 22, color: '#44403c' }}>Focus</span>
              <span style={{ fontSize: 12, color: '#a8a29e', marginLeft: 8 }}>needs attention now</span>
            </div>
          </div>
          <div style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 20, overflow: 'hidden' }}>
            {focusItems.length === 0 && (
              <div style={{ padding: '32px', textAlign: 'center', color: '#a8a29e', fontSize: 14 }}>ðŸŽ‰ All urgent items done!</div>
            )}
            {focusItems.map((item, idx) => (
              <div key={item.id} style={{
                borderBottom: idx < focusItems.length - 1 ? '1px solid #f5f3f0' : 'none',
                padding: '0 20px'
              }}>
                <ItemCard
                  item={item}
                  settings={settings}
                  variant="line"
                  showCategoryTag
                  onToggle={onToggle}
                  onEdit={onEdit}
                  onDelete={onDelete}
                  onAddComment={onAddComment}
                  onChangeMonth={onChangeMonth}
                  onTogglePin={onTogglePin}
                  celebrating={celebratingId === item.id}
                />
              </div>
            ))}
          </div>
        </div>

        {/* Overview */}
        <div className="fade-in fade-in-delay-3" style={{ marginBottom: 28 }}>
          <div style={{ marginBottom: 14 }}>
            <span className="serif" style={{ fontSize: 22, color: '#44403c' }}>Overview</span>
            <span style={{ fontSize: 12, color: '#a8a29e', marginLeft: 8 }}>tap to explore</span>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 10 }}>
            {catStats.map(({ cat, info, total, done, pct }) => (
              <div key={cat}
                className="hover-lift transition-smooth"
                onClick={() => onCategoryClick(cat)}
                style={{ background: 'white', border: '1px solid #ebe7e0', borderRadius: 16, padding: '16px 12px', cursor: 'pointer' }}>
                <div style={{ fontSize: 24, marginBottom: 6 }}>{info.emoji}</div>
                <div style={{ fontSize: 11, color: '#57534e', fontWeight: 500, marginBottom: 4 }}>{info.label}</div>
                <div style={{ fontSize: 11, color: '#a8a29e', marginBottom: 8 }}>{done} / {total}</div>
                <ProgressBar pct={pct} />
              </div>
            ))}
          </div>
        </div>

        {/* Budget */}
        <div className="fade-in fade-in-delay-4" style={{ marginBottom: 28 }}>
          <div style={{ marginBottom: 14 }}>
            <span className="serif" style={{ fontSize: 22, color: '#44403c' }}>Budget</span>
          </div>
          <div style={{ fontSize: 12, color: '#a8a29e', marginBottom: 10 }}>
            Category budgets total: {fmt(Object.values(settings.categoryBudgets || {}).reduce((s, v) => s + (Number(v) || 0), 0))}
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
            <StatBox label="Estimated" value={fmt(estimated)} sub="sum of item budgets" />
            <StatBox label="Identified" value={identified > 0 ? fmt(identified) : 'â€”'} sub="product prices found" />
            <StatBox label="Spent" value={spent > 0 ? fmt(spent) : 'â€”'} sub="actual costs logged" />
            <StatBox label="Remaining" value={fmt(Math.max(0, saving))} sub="item budgets minus spend" />
          </div>
        </div>
      </div>

      {/* Add button */}
      <div style={{ position: 'fixed', bottom: 24, right: 24, zIndex: 20 }}>
        <button onClick={() => onAdd(null)}
          style={{ width: 56, height: 56, borderRadius: '50%', background: '#6b7869', border: 'none', color: 'white', fontSize: 24, cursor: 'pointer', boxShadow: '0 8px 24px rgba(107,120,105,0.35)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontFamily: 'Inter' }}
          className="hover-lift transition-smooth">
          +
        </button>
      </div>
    </div>
  );
};

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const App = () => {
  const [items, setItems] = useState([]);
  const [settings, setSettings] = useState(DEFAULT_SETTINGS);
  const [loading, setLoading] = useState(true);
  const [screen, setScreen] = useState('home'); // 'home' | 'category' | 'timeline'
  const [activeCategory, setActiveCategory] = useState(null);
  const [editingItem, setEditingItem] = useState(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [addCategory, setAddCategory] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [celebratingId, setCelebratingId] = useState(null);
  const [error, setError] = useState(null);
  const [updatesRaw, setUpdatesRaw] = useState([]);
  const [userName, setUserName] = useState(getUserName());

const [hideActivityPanel, setHideActivityPanel] = useState(false);
const [lastSeenUpdatesAtMs, setLastSeenUpdatesAtMs] = useState(() => getLastSeenUpdatesAt());
const setLastSeenUpdatesAtBoth = useCallback((ms) => {
  const v = ms || 0;
  setLastSeenUpdatesAtMs(v);
  setLastSeenUpdatesAt(v);
}, []);
const [showPurchasedModal, setShowPurchasedModal] = useState(false);

  const [showNameModal, setShowNameModal] = useState(false);

  // Initialize Firebase
  useEffect(() => {
    let unsubItems, unsubSettings, unsubUpdates;

    const init = async () => {
      try {
        // Check items
        const snap = await db.collection('items').get();
        if (snap.empty) {
          const batch = db.batch();
          INITIAL_ITEMS.forEach(item => {
            const ref = db.collection('items').doc(String(item.id));
            batch.set(ref, item);
          });
          await batch.commit();
        }

        // Check settings
        const settingsSnap = await db.collection('settings').doc('general').get();
        if (!settingsSnap.exists) {
          await db.collection('settings').doc('general').set(DEFAULT_SETTINGS);
        }

        // Subscribe to real-time updates
        unsubItems = db.collection('items').onSnapshot(snap => {
          const data = snap.docs.map(d => d.data());
          setItems(data.sort((a, b) => a.id - b.id));
          setLoading(false);
        });

        unsubSettings = db.collection('settings').doc('general').onSnapshot(snap => {
          if (snap.exists) setSettings(snap.data());
        });

// Subscribe to lightweight recent updates (signals only)
unsubUpdates = db.collection('updates').orderBy('at', 'desc').limit(50).onSnapshot(snap => {
  const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  setUpdatesRaw(data);
});
      } catch (err) {
        console.error(err);
        setError(err.message);
        setLoading(false);
      }
    };

    init();
    return () => { unsubItems && unsubItems(); unsubSettings && unsubSettings(); unsubUpdates && unsubUpdates(); };
  }, []);

  const toggleItem = useCallback(async (id) => {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const wasPurchased = item.purchased;
    await db.collection('items').doc(String(id)).update({ purchased: !wasPurchased });
    await logUpdate({ type: UPDATE_EVENT_TYPES.PURCHASED_TOGGLED, itemId: id, itemName: item.item, category: item.category });
    if (!wasPurchased) {
      setCelebratingId(id);
      setTimeout(() => setCelebratingId(null), 1000);
    }
  }, [items]);

  const saveItem = useCallback(async (formData) => {
    if (editingItem) {
      const before = items.find(i => i.id === editingItem.id);
      await db.collection('items').doc(String(editingItem.id)).update(formData);
      // Only log assignment changes (signal, not noise)
      if (before && before.assignedTo !== formData.assignedTo) {
        await logUpdate({ type: UPDATE_EVENT_TYPES.ASSIGNED_CHANGED, itemId: editingItem.id, itemName: before.item, category: before.category });
      }
    } else {
      const maxId = items.reduce((m, i) => Math.max(m, i.id), 0);
      const newId = maxId + 1;
      await db.collection('items').doc(String(newId)).set({ ...formData, id: newId });
    }
    setEditingItem(null);
    setShowAddForm(false);
  }, [editingItem, items]);

  const deleteItem = useCallback(async (id) => {
    if (window.confirm('Remove this item?')) {
      await db.collection('items').doc(String(id)).delete();
    }
  }, []);

  const addComment = useCallback(async (id, comment) => {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const comments = [...(item.comments || []), comment];
    await db.collection('items').doc(String(id)).update({ comments });
    await logUpdate({ type: UPDATE_EVENT_TYPES.COMMENT_ADDED, itemId: id, itemName: item.item, category: item.category });
  }, [items]);

  
  const changeMonth = useCallback(async (id, targetMonth) => {
    const item = items.find(i => i.id === id);
    if (!item) return;
    await db.collection('items').doc(String(id)).update({ targetMonth });
  }, [items]);

  const togglePin = useCallback(async (id) => {
    const item = items.find(i => i.id === id);
    if (!item) return;
    await db.collection('items').doc(String(id)).update({ pinnedFocus: !item.pinnedFocus });
  }, [items]);

const saveSettings = useCallback(async (newSettings) => {
    await db.collection('settings').doc('general').set(newSettings);
    setSettings(newSettings);
  }, []);

  const handleAdd = (category) => {
    setAddCategory(category);
    setEditingItem(null);
    setShowAddForm(true);
  };

  const handleEdit = (item) => {
    setEditingItem(item);
    setShowAddForm(true);
  };

useEffect(() => {
  // Prompt for a name once per device, but don't nag if dismissed
  if (!userName && !getNameDismissed()) setShowNameModal(true);
}, []);

const hasNewUpdates = useMemo(() => {
  const lastSeen = lastSeenUpdatesAtMs || 0;
  return (updatesRaw || []).some(u => {
    const ms = (u && u.at && typeof u.at.toMillis === 'function') ? u.at.toMillis() : (u && u.at && u.at.seconds ? u.at.seconds * 1000 : 0);
    return ms && ms > lastSeen;
  });
}, [updatesRaw, lastSeenUpdatesAtMs]);

const markUpdatesSeen = useCallback(() => {
  // Use the latest server timestamp we can see (avoids clock skew keeping the dot stuck on)
  const latestMs = (updatesRaw || []).reduce((max, u) => {
    const ms = (u && u.at && typeof u.at.toMillis === 'function')
      ? u.at.toMillis()
      : (u && u.at && u.at.seconds ? u.at.seconds * 1000 : 0);
    return ms > max ? ms : max;
  }, 0);
  setLastSeenUpdatesAtBoth(latestMs || Date.now());
  setHideActivityPanel(true);
}, [updatesRaw, setHideActivityPanel, setLastSeenUpdatesAtBoth]);

const dismissNameModal = useCallback(() => {
  setNameDismissed(true);
  setShowNameModal(false);
}, []);

const openNameModal = useCallback(() => { setNameDismissed(false); setShowNameModal(true); }, []);

const saveUserName = useCallback((name) => {
  try { localStorage.setItem("registryUser", name); } catch {}
  setNameDismissed(false);
  setUserName(name);
}, []);

  if (loading) {
    return (
      <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#faf9f7', flexDirection: 'column', gap: 16 }}>
        <div className="serif" style={{ fontSize: 32, color: '#8a9688' }}>Baby Tyrrell</div>
        <div style={{ fontSize: 13, color: '#a8a29e' }}>Loading your registryâ€¦</div>
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#faf9f7', flexDirection: 'column', gap: 16, padding: 24 }}>
        <div className="serif" style={{ fontSize: 28, color: '#44403c' }}>Connection Error</div>
        <div style={{ fontSize: 13, color: '#a8a29e', textAlign: 'center', maxWidth: 320 }}>Unable to connect to Firebase. Check your internet connection.<br/><br/><code style={{ fontSize: 11 }}>{error}</code></div>
      </div>
    );
  }

  return (
    <div>
      {screen === 'home' && (
        <HomeDashboard
          items={items}
          settings={settings}
          updatesRaw={updatesRaw}
          userName={userName}
          onSetUserName={openNameModal}
          onMarkUpdatesSeen={markUpdatesSeen}
          hasNewUpdates={hasNewUpdates}
          hideActivityPanel={hideActivityPanel}
          onHideActivityPanel={setHideActivityPanel}
          onOpenPurchased={() => setShowPurchasedModal(true)}
          onOpenTimeline={() => setScreen('timeline')}

          onCategoryClick={cat => { setActiveCategory(cat); setScreen('category'); }}
          onToggle={toggleItem}
          onEdit={handleEdit}
          onDelete={deleteItem}
          onAddComment={addComment}
          onChangeMonth={changeMonth}
          onTogglePin={togglePin}
          celebratingId={celebratingId}
          onOpenSettings={() => setShowSettings(true)}
          onAdd={handleAdd}
        />
      )}

      {screen === 'category' && activeCategory && (
        <CategoryView
          category={activeCategory}
          items={items}
          onBack={() => setScreen('home')}
          onToggle={toggleItem}
          onEdit={handleEdit}
          onDelete={deleteItem}
          onAddComment={addComment}
          onAdd={handleAdd}
          celebratingId={celebratingId}
        />
      )}

      {screen === 'timeline' && (
        <TimelineView
          items={items}
          settings={settings}
          onBack={() => setScreen('home')}
          onToggle={toggleItem}
          onEdit={handleEdit}
          onDelete={deleteItem}
          onAddComment={addComment}
          onChangeMonth={changeMonth}
          onTogglePin={togglePin}
          celebratingId={celebratingId}
        />
      )}


      {/* Item Form Modal */}
      {showAddForm && (
        <ItemFormModal
          item={editingItem ? editingItem : (addCategory ? { category: addCategory } : null)}
          onSave={saveItem}
          onClose={() => { setShowAddForm(false); setEditingItem(null); }}
        />
      )}

      {/* Settings Modal */}
      

{showNameModal && (
  <NameModal
    initialName={userName}
    onSave={saveUserName}
    onClose={dismissNameModal}
  />
)}

{showPurchasedModal && (
  <PurchasedModal items={items} onToggle={toggleItem} onClose={() => setShowPurchasedModal(false)} />
)}


      {showSettings && (
        <SettingsModal
          settings={settings}
          onSave={saveSettings}
          onClose={() => setShowSettings(false)}
        />
      )}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
